#include "InstructionSet.h"
#include "registers.h"
#include "RAM.h"


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Extract register8 from bits 0...2
static REG_8 Reg8Lo(uint8 value)
{
    return (REG_8)(value & 7);
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
// Ettract registers8 from bits 3...5
static REG_8 Reg8Hi(uint8 value)
{
    return (REG_8)((value >> 3) & 7);
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
// Extract REG_DD register from bits 4...5
static REG_DD RegDD45(uint8 value)
{
    return (REG_DD)((value >> 4) & 3);
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
// Extract REG_QQ register from bits 4...5
static REG_QQ RegQQ45(uint8 value)
{
    return (REG_QQ)((value >> 4) & 3);
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_R_R(void)
{
    uint8 value = PrevPC();

    REG_8 dest = Reg8Hi(value);
    REG_8 src = Reg8Lo(value);

    LoadReg8(dest, GetReg8(src));

    return 4;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_R_N(void)
{
    uint8 value = PrevPC();

    REG_8 dest = Reg8Hi(value);

    LoadReg8(dest, PCandInc());

    return 7;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_R_pHL(void)
{
    uint8 value = PrevPC();

    REG_8 dest = Reg8Hi(value);

    LoadReg8(dest, GetReg8(RpHL));

    return 7;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_pHL_R(void)
{
    uint8 value = PrevPC();

    REG_8 src = Reg8Lo(value);

    LoadReg8(RpHL, GetReg8(src));

    return 7;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_pHL_N(void)
{
    LoadReg8(RpHL, PCandInc());

    return 10;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_A_pBC(void)
{
    LoadReg8(RA, RAM[GetRegQQ(RQQ_BC)]);

    return 7;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_A_pDE(void)
{
    LoadReg8(RA, RAM[GetRegQQ(RQQ_DE)]);

    return 7;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_A_NN(void)
{
    uint16 address = PCandInc16();

    LoadReg8(RA, RAM[address]);

    return 13;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_pBC_A(void)
{
    uint16 address = GetRegQQ(RQQ_BC);

    RAM[address] = GetReg8(RA);

    return 7;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_pDE_A(void)
{
    uint16 address = GetRegQQ(RQQ_DE);

    RAM[address] = GetReg8(RA);

    return 7;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_pNN_A(void)
{
    uint16 address = PCandInc16();

    RAM[address] = GetReg8(RA);

    return 13;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_DD_NN(void)
{
    REG_DD reg = RegDD45(PrevPC());

    LoadRegDD(reg, PCandInc16());

    return 10;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_pNN_HL(void)
{
    uint16 address = PCandInc16();

    RAM[address] = GetReg8(RL);
    RAM[address + 1] = GetReg8(RH);

    return 16;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_SP_HL(void)
{
    uint16 value = GetRegDD(RDD_HL);
    LoadRegDD(RDD_SP, value);

    return 6;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int PUSH_QQ(void)
{
    uint16 valueSP = GetRegDD(RDD_SP);

    REG_QQ regQQ = RegQQ45(PrevPC());

    uint16 valueQQ = GetRegQQ(regQQ);

    RAM[valueSP - 2] = (uint8)valueQQ;
    RAM[valueSP - 1] = (uint8)(valueQQ >> 8);

    LoadRegDD(RDD_SP, valueSP - 2);

    return 11;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int POP_QQ(void)
{
    REG_QQ regQQ = RegQQ45(PrevPC());

    uint16 valueSP = GetRegDD(RDD_SP);

    uint16 valueQQ = (RAM[valueSP]) + (RAM[valueSP + 1] * 256);

    LoadRegQQ(regQQ, valueQQ);

    LoadRegDD(RDD_SP, GetRegDD(RDD_SP) + 2);

    return 10;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int EX_DE_HL(void)
{
    uint16 valueDE = GetRegDD(RDD_DE);
    uint16 valueHL = GetRegDD(RDD_HL);

    LoadRegDD(RDD_DE, valueHL);
    LoadRegDD(RDD_HL, valueDE);

    return 4;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int EX_AF_AFalt(void)
{
    ExchangeReg8(RA);
    ExchangeReg8(RF);

    return 4;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int EXX(void)
{
    ExchangeReg8(RB);
    ExchangeReg8(RC);
    ExchangeReg8(RD);
    ExchangeReg8(RE);
    ExchangeReg8(RH);
    ExchangeReg8(RL);

    return 4;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int EX_pSP_HL(void)
{
    uint16 address = GetRegDD(RDD_SP);
    uint8 hi = GetReg8(RH);
    uint8 low = GetReg8(RL);

    uint8 temp = RAM[address + 1];
    RAM[address + 1] = hi;
    hi = temp;

    temp = RAM[address];
    RAM[address] = low;
    low = temp;

    LoadReg8(RH, hi);
    LoadReg8(RL, low);

    return 9;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int ADD_A_R(void)
{
    REG_8 reg = Reg8Lo(PrevPC());

    LoadReg8(RA, GetReg8(RA) + GetReg8(reg));

    return 4;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int ADD_A_N(void)
{
    LoadReg8(RA, GetReg8(RA) + PCandInc());

    return 7;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int ADD_A_pHL(void)
{
    LoadReg8(RA, GetReg8(RA) + GetReg8(RpHL));

    return 7;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int ADC_A_S(void)
{
    LoadReg8(RA, GetReg8(RA) + GetReg8(Reg8Lo(PrevPC())) + CY());

    return 4;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int ADC_A_N(void)
{
    LoadReg8(RA, GetReg8(RA) + PCandInc() + CY());

    return 7;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int ADC_A_pHL(void)
{
    LoadReg8(RA, GetReg8(RA) + GetReg8(RpHL) + CY());

    return 7;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int SUB_S(void)
{
    REG_8 reg = Reg8Lo(PrevPC());

    LoadReg8(RA, GetReg8(RA) - GetReg8(reg));

    return 4;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int SUB_N(void)
{
    LoadReg8(RA, PCandInc())
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_HL_pNN(void)
{
    LoadRegDD(RDD_HL, PCandInc16());

    return 16;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int RunCommand(void)
{
    const pFuncIV firstLevel[256] =
    {
        /*   00 000 000   */ NOP,
        /*   00 000 010   */ LD_pBC_A,
        /*   00 000 011   */ INC_SS,
        /*   00 000 001   */ LD_DD_NN,
        /*   00 000 100   */ INC_R,
        /*   00 000 101   */ DEC_M,
        /*   00 000 110   */ LD_R_N,
        /*   00 000 111   */ RLCA,
        /*   00 001 000   */ EX_AF_AFalt,
        /*   00 001 001   */ ADD_HL_SS,
        /*   00 001 010   */ LD_A_pBC,
        /*   00 001 011   */ DEC_SS,
        /*   00 001 100   */ INC_R,
        /*   00 001 101   */ DEC_M,
        /*   00 001 110   */ LD_R_N,
        /*   00 001 111   */ RRCA,
        /*   00 010 000   */ DJNZ_E,
        /*   00 010 001   */ LD_DD_NN,
        /*   00 010 010   */ LD_pDE_A,
        /*   00 010 011   */ INC_SS,
        /*   00 010 100   */ INC_R,
        /*   00 010 101   */ DEC_M,
        /*   00 010 110   */ LD_R_N,
        /*   00 010 111   */ RLA,
        /*   00 011 000   */ JR_E,
        /*   00 011 001   */ ADD_HL_SS,
        /*   00 011 010   */ LD_A_pDE,
        /*   00 011 011   */ DEC_SS,
        /*   00 011 100   */ INC_R,
        /*   00 011 101   */ DEC_M,
        /*   00 011 110   */ LD_R_N,
        /*   00 011 111   */ RRA,
        /*   00 100 000   */ JR_NZ_E,
        /*   00 100 001   */ LD_DD_NN,
        /*   00 100 010   */ LD_pNN_HL,
        /*   00 100 011   */ INC_SS,
        /*   00 100 100   */ INC_R,
        /*   00 100 101   */ DEC_M,
        /*   00 100 110   */ LD_R_N,
        /*   00 100 111   */ DAA,
        /*   00 101 000   */ JR_Z_E,
        /*   00 101 001   */ ADD_HL_SS,
        /*   00 101 010   */ LD_HL_pNN,
        /*   00 101 011   */ DEC_SS,
        /*   00 101 100   */ INC_R,
        /*   00 101 101   */ DEC_M,
        /*   00 101 110   */ LD_R_N,
        /*   00 101 111   */ CPL,
        /*   00 110 000   */ JR_NC_E,
        /*   00 110 001   */ LD_DD_NN,
        /*   00 110 010   */ LD_pNN_A,
        /*   00 110 011   */ INC_SS,
        /*   00 110 100   */ INC_pHL,
        /*   00 110 101   */ DEC_pHL,
        /*   00 110 110   */ LD_pHL_N,
        /*   00 110 111   */ SCF,
        /*   00 111 000   */ JR_C_E,
        /*   00 111 001   */ ADD_HL_SS,
        /*   00 111 010   */ LD_A_NN,
        /*   00 111 011   */ DEC_SS,
        /*   00 111 100   */ INC_R,
        /*   00 111 101   */ DEC_M,
        /*   00 111 110   */ LD_R_N,
        /*   00 111 111   */ CCF,

        /*   01 000 000   */ LD_R_R,
        /*   01 000 001   */ LD_R_R,
        /*   01 000 010   */ LD_R_R,
        /*   01 000 011   */ LD_R_R,
        /*   01 000 100   */ LD_R_R,
        /*   01 000 101   */ LD_R_R,
        /*   01 000 110   */ LD_R_pHL,
        /*   01 000 111   */ LD_R_R,
        /*   01 001 000   */ LD_R_R,
        /*   01 001 001   */ LD_R_R,
        /*   01 001 010   */ LD_R_R,
        /*   01 001 011   */ LD_R_R,
        /*   01 001 100   */ LD_R_R,
        /*   01 001 101   */ LD_R_R,
        /*   01 001 110   */ LD_R_pHL,
        /*   01 001 111   */ LD_R_R,
        /*   01 010 000   */ LD_R_R,
        /*   01 010 001   */ LD_R_R,
        /*   01 010 010   */ LD_R_R,
        /*   01 010 011   */ LD_R_R,
        /*   01 010 100   */ LD_R_R,
        /*   01 010 101   */ LD_R_R,
        /*   01 010 110   */ LD_R_pHL,
        /*   01 010 111   */ LD_R_R,
        /*   01 011 000   */ LD_R_R,
        /*   01 011 001   */ LD_R_R,
        /*   01 011 010   */ LD_R_R,
        /*   01 011 011   */ LD_R_R,
        /*   01 011 100   */ LD_R_R,
        /*   01 011 101   */ LD_R_R,
        /*   01 011 110   */ LD_R_pHL,
        /*   01 011 111   */ LD_R_R,
        /*   01 100 000   */ LD_R_R,
        /*   01 100 001   */ LD_R_R,
        /*   01 100 010   */ LD_R_R,
        /*   01 100 011   */ LD_R_R,
        /*   01 100 100   */ LD_R_R,
        /*   01 100 101   */ LD_R_R,
        /*   01 100 110   */ LD_R_pHL,
        /*   01 100 111   */ LD_R_R,
        /*   01 101 000   */ LD_R_R,
        /*   01 101 001   */ LD_R_R,
        /*   01 101 010   */ LD_R_R,
        /*   01 101 011   */ LD_R_R,
        /*   01 101 100   */ LD_R_R,
        /*   01 101 101   */ LD_R_R,
        /*   01 101 110   */ LD_R_pHL,
        /*   01 101 111   */ LD_R_R,
        /*   01 110 000   */ LD_pHL_R,
        /*   01 110 001   */ LD_pHL_R,
        /*   01 110 010   */ LD_pHL_R,
        /*   01 110 011   */ LD_pHL_R,
        /*   01 110 100   */ LD_pHL_R,
        /*   01 110 101   */ LD_pHL_R,
        /*   01 110 110   */ HALT,
        /*   01 110 111   */ LD_pHL_R,
        /*   01 111 000   */ LD_R_R,
        /*   01 111 001   */ LD_R_R,
        /*   01 111 010   */ LD_R_R,
        /*   01 111 011   */ LD_R_R,
        /*   01 111 100   */ LD_R_R,
        /*   01 111 101   */ LD_R_R,
        /*   01 111 110   */ LD_R_pHL,
        /*   01 111 111   */ LD_R_R,

        /*   10 000 000   */ ADD_A_R,
        /*   10 000 001   */ ADD_A_R,
        /*   10 000 010   */ ADD_A_R,
        /*   10 000 011   */ ADD_A_R,
        /*   10 000 100   */ ADD_A_R,
        /*   10 000 101   */ ADD_A_R,
        /*   10 000 110   */ ADD_A_pHL,
        /*   10 000 111   */ ADD_A_R,
        /*   10 001 000   */ ADC_A_S,
        /*   10 001 001   */ ADC_A_S,
        /*   10 001 010   */ ADC_A_S,
        /*   10 001 011   */ ADC_A_S,
        /*   10 001 100   */ ADC_A_S,
        /*   10 001 101   */ ADC_A_S,
        /*   10 001 110   */ ADC_A_pHL,
        /*   10 001 111   */ ADC_A_S,
        /*   10 010 000   */ SUB_S,
        /*   10 010 001   */ SUB_S,
        /*   10 010 010   */ SUB_S,
        /*   10 010 011   */ SUB_S,
        /*   10 010 100   */ SUB_S,
        /*   10 010 101   */ SUB_S,
        /*   10 010 110   */ SUB_pHL,
        /*   10 010 111   */ SUB_S,
        /*   10 011 000   */ SBC_A_S,
        /*   10 011 001   */ SBC_A_S,
        /*   10 011 010   */ SBC_A_S,
        /*   10 011 011   */ SBC_A_S,
        /*   10 011 100   */ SBC_A_S,
        /*   10 011 101   */ SBC_A_S,
        /*   10 011 110   */ SBC_A_pHL,
        /*   10 011 111   */ SBC_A_S,
        /*   10 100 000   */ AND_S,
        /*   10 100 001   */ AND_S,
        /*   10 100 010   */ AND_S,
        /*   10 100 011   */ AND_S,
        /*   10 100 100   */ AND_S,
        /*   10 100 101   */ AND_S,
        /*   10 100 110   */ AND_pHL,
        /*   10 100 111   */ AND_S,
        /*   10 101 000   */ XOR_S,
        /*   10 101 001   */ XOR_S,
        /*   10 101 010   */ XOR_S,
        /*   10 101 011   */ XOR_S,
        /*   10 101 100   */ XOR_S,
        /*   10 101 101   */ XOR_S,
        /*   10 101 110   */ XOR_pHL,
        /*   10 101 111   */ XOR_S,
        /*   10 110 000   */ OR_S,
        /*   10 110 001   */ OR_S,
        /*   10 110 010   */ OR_S,
        /*   10 110 011   */ OR_S,
        /*   10 110 100   */ OR_S,
        /*   10 110 101   */ OR_S,
        /*   10 110 110   */ OR_pHL,
        /*   10 110 111   */ OR_S,
        /*   10 111 000   */ CP_S,
        /*   10 111 001   */ CP_S,
        /*   10 111 010   */ CP_S,
        /*   10 111 011   */ CP_S,
        /*   10 111 100   */ CP_S,
        /*   10 111 101   */ CP_S,
        /*   10 111 110   */ CP_pHL,
        /*   10 111 111   */ CP_S,
        /*   11 000 000   */ RET_CC,
        /*   11 000 001   */ POP_QQ,
        /*   11 000 010   */ JP_CC_NN,
        /*   11 000 011   */ JP_NN,
        /*   11 000 100   */ CALL_CC_NN,
        /*   11 000 101   */ PUSH_QQ,
        /*   11 000 110   */ ADD_A_N,
        /*   11 000 111   */ RST_P,
        /*   11 001 000   */ RET_CC,
        /*   11 001 001   */ RET,
        /*   11 001 010   */ JP_CC_NN,
        /*   11 001 011   */ RunCommandWithPrefixCB,
        /*   11 001 100   */ CALL_CC_NN,
        /*   11 001 101   */ CALL_NN,
        /*   11 001 110   */ ADC_A_N,
        /*   11 001 111   */ RST_P,
        /*   11 010 000   */ RET_CC,
        /*   11 010 001   */ POP_QQ,
        /*   11 010 010   */ JP_CC_NN,
        /*   11 010 011   */ OUT_pN_A,
        /*   11 010 100   */ CALL_CC_NN,
        /*   11 010 101   */ PUSH_QQ,
        /*   11 010 110   */ SUB_N,
        /*   11 010 111   */ RST_P,
        /*   11 011 000   */ RET_CC,
        /*   11 011 001   */ EXX,
        /*   11 011 010   */ JP_CC_NN,
        /*   11 011 011   */ IN_A_pN,
        /*   11 011 100   */ CALL_CC_NN,
        /*   11 011 101   */ RunCommandWithPrefixDD,
        /*   11 011 110   */ SBC_A_N,
        /*   11 011 111   */ RST_P,
        /*   11 100 000   */ RET_CC,
        /*   11 100 001   */ POP_QQ,
        /*   11 100 010   */ JP_CC_NN,
        /*   11 100 011   */ EX_pSP_HL,
        /*   11 100 100   */ CALL_CC_NN,
        /*   11 100 101   */ PUSH_QQ,
        /*   11 100 110   */ AND_N,
        /*   11 100 111   */ RST_P,
        /*   11 101 000   */ RET_CC,
        /*   11 101 001   */ JP_pHL,
        /*   11 101 010   */ JP_CC_NN,
        /*   11 101 011   */ EX_DE_HL,
        /*   11 101 100   */ CALL_CC_NN,
        /*   11 101 101   */ RunCommandWithPrefixED,
        /*   11 101 110   */ XOR_N,
        /*   11 101 111   */ RST_P,
        /*   11 110 000   */ RET_CC,
        /*   11 110 001   */ POP_QQ,
        /*   11 110 010   */ JP_CC_NN,
        /*   11 110 011   */ DI,
        /*   11 110 100   */ CALL_CC_NN,
        /*   11 110 101   */ PUSH_QQ,
        /*   11 110 110   */ OR_N,
        /*   11 110 111   */ RST_P,
        /*   11 111 000   */ RET_CC,
        /*   11 111 001   */ LD_SP_HL,
        /*   11 111 010   */ JP_CC_NN,
        /*   11 111 011   */ EI,
        /*   11 111 100   */ CALL_CC_NN,
        /*   11 111 101   */ RunCommandWithPrefixFD,
        /*   11 111 110   */ CP_N,
        /*   11 111 111   */ RST_P
    };

    return firstLevel[PCandInc()]();
}
