#include "instrDD.h"
#include "defines.h"
#include "registers.h"
#include "RAM.h"
#include "common.h"
#include "instrThirdLeevl.h"


#include <string.h>

#include <stdio.h>

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
int LD_R_pIX_D(void)
{
    uint8 valueReg = prevPC;

    R8_HI(valueReg) = RAM[IX + PCandInc()];
    
    return 19;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_pIX_D_R(void)
{
    uint8 valueReg = prevPC;

    RAM[IX + PCandInc()] = R8_LO(valueReg);

    return 19;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_pIX_D_N(void)
{
    uint8 valD = PCandInc();
    uint8 valN = PCandInc();
    RAM[IX + valD] = valN;
    return 19;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_IX_NN(void)
{
#ifdef LISTING

    AddOpcode(RAM8(PC));
    AddOpcode(RAM8(PC));
    AddAddress(PC + 2);
    sprintf(mnemonic, "LD IX,%04X", PC16andInc());
    return -1;

#else

    IX = PC16andInc();
    return 14;

#endif
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_IX_pNN(void)
{
    IX = RAM16(PC16andInc());
    return 20;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_pNN_IX(void)
{
    RAM16(PC16andInc()) = IX;
    return 20;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int LD_SP_IX(void)
{
    SP = IX;
    return 10;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int PUSH_IX(void)
{
    RAM16(SP - 2) = IX;
    SP -= 2;
    return 15;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int POP_IX(void)
{
    IX = RAM16(SP);
    SP += 2;
    return 14;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int EX_pSP_IX(void)
{
    uint16 temp;
    EXCH(IX, RAM16(SP));
    return 23;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int ADD_A_pIX_D(void)
{
    A += RAM8(IX + PCandInc());
    return 19;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int INC_pIX_D(void)
{
    RAM16(IX + PCandInc()) += 1;
    return 23;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int ADD_IX_PP(void)
{
#ifdef LISTING

    AddAddress(PC);
    sprintf(mnemonic, "ADD IX,%s", PP_45_Name(prevPC));
    return -1;

#else

    IX += PP_45(prevPC);
    return 15;

#endif
}

//------------------------------------------------------------------------------------------------------------------------------------------------------
int DEC_IX(void)
{
    IX -= 1;
    return 10;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int INC_IX(void)
{
    IX += 1;
    return 10;
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int JP_pIX(void)
{
#ifdef LISTING

    strcpy(mnemonic, "JP [IX]");
    return -1;

#else

    PC = IX;
    return 8;

#endif
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int RLC_pIX_D_and_BIT_B_pIX_D_and_SET_B_pIX_D_RES_B_pIX_D(void)
{
    return RunThridLevel(IR_IX);

    /*
#ifdef LISTING

    AddOpcode(RAM8(PC));
    AddOpcode(RAM8(PC + 1));
    AddAddress(PC + 2);

    uint8 valD = PCandInc();
    uint8 valBit = PCandInc();
    uint8 bit = (valBit >> 3) & 7;

    if ((valBit & 0xc7) == 0x86)    // RES b, [IX + d]
    {
        sprintf(mnemonic, "RES %d,[IX+%02X]", bit, valD);
        return -1;
    }

    return 1;

#else

    uint8 valD = PCandInc();
    uint8 sign = PCandInc();

    if(sign == 0x06)            // RLC (IX + D)
    {
        uint8 hiBit = GET_BIT(RAM8(IX + valD), 7);
        LOAD_C(hiBit);
        RAM8(IX + valD) <<= 1;
        LOAD_BIT(RAM8(IX + valD), 0, hiBit);
        return 23;
    }
    if((sign & 0x67) == 0x46)    // BIT B, (IX + D)
    {
        uint8 numBit = (valD >> 3) & 7;
        uint8 valueZ = GET_BIT(RAM8(IX + D), numBit);
        LOAD_Z(valueZ);
        return 20;
    }
    if((sign & 0xc7) == 0xc6)   // SET B, (IX + D)
    {
        uint8 numBit = (valD >> 3) & 7;
        RAM8(IX + D) |= (1 << numBit);
        return 23;
    }

    LOG_ERROR();

    return 0;

#endif
    */
}


//------------------------------------------------------------------------------------------------------------------------------------------------------
int RunCommandWithPrefixDD(void)
{
    const pFuncIV secondLevel[256] =
    {
        /*   00 000 000   */ 0,
        /*   00 000 001   */ 0,
        /*   00 000 010   */ 0,
        /*   00 000 011   */ 0,
        /*   00 000 100   */ 0,
        /*   00 000 101   */ 0,
        /*   00 000 110   */ 0,
        /*   00 000 111   */ 0,
        /*   00 001 000   */ 0,
        /*   00 001 001   */ ADD_IX_PP,
        /*   00 001 010   */ 0,
        /*   00 001 011   */ 0,
        /*   00 001 100   */ 0,
        /*   00 001 101   */ 0,
        /*   00 001 110   */ 0,
        /*   00 001 111   */ 0,
        /*   00 010 000   */ 0,
        /*   00 010 001   */ 0,
        /*   00 010 010   */ 0,
        /*   00 010 011   */ 0,
        /*   00 010 100   */ 0,
        /*   00 010 101   */ 0,
        /*   00 010 110   */ 0,
        /*   00 010 111   */ 0,
        /*   00 011 000   */ 0,
        /*   00 011 001   */ ADD_IX_PP,
        /*   00 011 010   */ 0,
        /*   00 011 011   */ 0,
        /*   00 011 100   */ 0,
        /*   00 011 101   */ 0,
        /*   00 011 110   */ 0,
        /*   00 011 111   */ 0,
        /*   00 100 000   */ 0,
        /*   00 100 001   */ LD_IX_NN,
        /*   00 100 010   */ LD_pNN_IX,
        /*   00 100 011   */ INC_IX,
        /*   00 100 100   */ 0,
        /*   00 100 101   */ 0,
        /*   00 100 110   */ 0,
        /*   00 100 111   */ 0,
        /*   00 101 000   */ 0,
        /*   00 101 001   */ ADD_IX_PP,
        /*   00 101 010   */ LD_IX_pNN,
        /*   00 101 011   */ DEC_IX,
        /*   00 101 100   */ 0,
        /*   00 101 101   */ 0,
        /*   00 101 110   */ 0,
        /*   00 101 111   */ 0,
        /*   00 110 000   */ 0,
        /*   00 110 001   */ 0,
        /*   00 110 010   */ 0,
        /*   00 110 011   */ 0,
        /*   00 110 100   */ INC_pIX_D,
        /*   00 110 101   */ 0,
        /*   00 110 110   */ LD_pIX_D_N,
        /*   00 110 111   */ 0,
        /*   00 111 000   */ 0,
        /*   00 111 001   */ ADD_IX_PP,
        /*   00 111 010   */ 0,
        /*   00 111 011   */ 0,
        /*   00 111 100   */ 0,
        /*   00 111 101   */ 0,
        /*   00 111 110   */ 0,
        /*   00 111 111   */ 0,
        /*   01 000 000   */ 0,
        /*   01 000 001   */ 0,
        /*   01 000 010   */ 0,
        /*   01 000 011   */ 0,
        /*   01 000 100   */ 0,
        /*   01 000 101   */ LD_R_pIX_D,
        /*   01 000 110   */ 0,
        /*   01 000 111   */ 0,
        /*   01 001 000   */ 0,
        /*   01 001 001   */ ADD_IX_PP,
        /*   01 001 010   */ 0,
        /*   01 001 011   */ 0,
        /*   01 001 100   */ 0,
        /*   01 001 101   */ LD_R_pIX_D,
        /*   01 001 110   */ 0,
        /*   01 001 111   */ 0,
        /*   01 010 000   */ 0,
        /*   01 010 001   */ 0,
        /*   01 010 010   */ 0,
        /*   01 010 011   */ 0,
        /*   01 010 100   */ 0,
        /*   01 010 101   */ LD_R_pIX_D,
        /*   01 010 110   */ 0,
        /*   01 010 111   */ 0,
        /*   01 011 000   */ 0,
        /*   01 011 001   */ ADD_IX_PP,
        /*   01 011 010   */ 0,
        /*   01 011 011   */ 0,
        /*   01 011 100   */ 0,
        /*   01 011 101   */ LD_R_pIX_D,
        /*   01 011 110   */ 0,
        /*   01 011 111   */ 0,
        /*   01 100 000   */ 0,
        /*   01 100 001   */ 0,
        /*   01 100 010   */ 0,
        /*   01 100 011   */ 0,
        /*   01 100 100   */ 0,
        /*   01 100 101   */ LD_R_pIX_D,
        /*   01 100 110   */ 0,
        /*   01 100 111   */ 0,
        /*   01 101 000   */ 0,
        /*   01 101 001   */ ADD_IX_PP,
        /*   01 101 010   */ 0,
        /*   01 101 011   */ 0,
        /*   01 101 100   */ 0,
        /*   01 101 101   */ LD_R_pIX_D,
        /*   01 101 110   */ 0,
        /*   01 101 111   */ 0,
        /*   01 110 000   */ LD_pIX_D_R,
        /*   01 110 001   */ LD_pIX_D_R,
        /*   01 110 010   */ LD_pIX_D_R,
        /*   01 110 011   */ LD_pIX_D_R,
        /*   01 110 100   */ LD_pIX_D_R,
        /*   01 110 101   */ LD_R_pIX_D,
        /*   01 110 110   */ LD_pIX_D_R,
        /*   01 110 111   */ LD_pIX_D_R,
        /*   01 111 000   */ 0,
        /*   01 111 001   */ ADD_IX_PP,
        /*   01 111 010   */ 0,
        /*   01 111 011   */ 0,
        /*   01 111 100   */ 0,
        /*   01 111 101   */ LD_R_pIX_D,
        /*   01 111 110   */ 0,
        /*   01 111 111   */ 0,
        /*   10 000 000   */ 0,
        /*   10 000 001   */ 0,
        /*   10 000 010   */ 0,
        /*   10 000 011   */ 0,
        /*   10 000 100   */ 0,
        /*   10 000 101   */ 0,
        /*   10 000 110   */ ADD_A_pIX_D,
        /*   10 000 111   */ 0,
        /*   10 001 000   */ 0,
        /*   10 001 001   */ 0,
        /*   10 001 010   */ 0,
        /*   10 001 011   */ 0,
        /*   10 001 100   */ 0,
        /*   10 001 101   */ 0,
        /*   10 001 110   */ 0,
        /*   10 001 111   */ 0,
        /*   10 010 000   */ 0,
        /*   10 010 001   */ 0,
        /*   10 010 010   */ 0,
        /*   10 010 011   */ 0,
        /*   10 010 100   */ 0,
        /*   10 010 101   */ 0,
        /*   10 010 110   */ 0,
        /*   10 010 111   */ 0,
        /*   10 011 000   */ 0,
        /*   10 011 001   */ 0,
        /*   10 011 010   */ 0,
        /*   10 011 011   */ 0,
        /*   10 011 100   */ 0,
        /*   10 011 101   */ 0,
        /*   10 011 110   */ 0,
        /*   10 011 111   */ 0,
        /*   10 100 000   */ 0,
        /*   10 100 001   */ 0,
        /*   10 100 010   */ 0,
        /*   10 100 011   */ 0,
        /*   10 100 100   */ 0,
        /*   10 100 101   */ 0,
        /*   10 100 110   */ 0,
        /*   10 100 111   */ 0,
        /*   10 101 000   */ 0,
        /*   10 101 001   */ 0,
        /*   10 101 010   */ 0,
        /*   10 101 011   */ 0,
        /*   10 101 100   */ 0,
        /*   10 101 101   */ 0,
        /*   10 101 110   */ 0,
        /*   10 101 111   */ 0,
        /*   10 110 000   */ 0,
        /*   10 110 001   */ 0,
        /*   10 110 010   */ 0,
        /*   10 110 011   */ 0,
        /*   10 110 100   */ 0,
        /*   10 110 101   */ 0,
        /*   10 110 110   */ 0,
        /*   10 110 111   */ 0,
        /*   10 111 000   */ 0,
        /*   10 111 001   */ 0,
        /*   10 111 010   */ 0,
        /*   10 111 011   */ 0,
        /*   10 111 100   */ 0,
        /*   10 111 101   */ 0,
        /*   10 111 110   */ 0,
        /*   10 111 111   */ 0,
        /*   11 000 000   */ 0,
        /*   11 000 001   */ 0,
        /*   11 000 010   */ 0,
        /*   11 000 011   */ 0,
        /*   11 000 100   */ 0,
        /*   11 000 101   */ 0,
        /*   11 000 110   */ 0,
        /*   11 000 111   */ 0,
        /*   11 001 000   */ 0,
        /*   11 001 001   */ 0,
        /*   11 001 010   */ 0,
        /*   11 001 011   */ RLC_pIX_D_and_BIT_B_pIX_D_and_SET_B_pIX_D_RES_B_pIX_D,
        /*   11 001 100   */ 0,
        /*   11 001 101   */ 0,
        /*   11 001 110   */ 0,
        /*   11 001 111   */ 0,
        /*   11 010 000   */ 0,
        /*   11 010 001   */ 0,
        /*   11 010 010   */ 0,
        /*   11 010 011   */ 0,
        /*   11 010 100   */ 0,
        /*   11 010 101   */ 0,
        /*   11 010 110   */ 0,
        /*   11 010 111   */ 0,
        /*   11 011 000   */ 0,
        /*   11 011 001   */ 0,
        /*   11 011 010   */ 0,
        /*   11 011 011   */ 0,
        /*   11 011 100   */ 0,
        /*   11 011 101   */ 0,
        /*   11 011 110   */ 0,
        /*   11 011 111   */ 0,
        /*   11 100 000   */ 0,
        /*   11 100 001   */ POP_IX,
        /*   11 100 010   */ 0,
        /*   11 100 011   */ EX_pSP_IX,
        /*   11 100 100   */ 0,
        /*   11 100 101   */ PUSH_IX,
        /*   11 100 110   */ 0,
        /*   11 100 111   */ 0,
        /*   11 101 000   */ 0,
        /*   11 101 001   */ JP_pIX,
        /*   11 101 010   */ 0,
        /*   11 101 011   */ 0,
        /*   11 101 100   */ 0,
        /*   11 101 101   */ 0,
        /*   11 101 110   */ 0,
        /*   11 101 111   */ 0,
        /*   11 110 000   */ 0,
        /*   11 110 001   */ 0,
        /*   11 110 010   */ 0,
        /*   11 110 011   */ 0,
        /*   11 110 100   */ 0,
        /*   11 110 101   */ 0,
        /*   11 110 110   */ 0,
        /*   11 110 111   */ 0,
        /*   11 111 000   */ 0,
        /*   11 111 001   */ LD_SP_IX,
        /*   11 111 010   */ 0,
        /*   11 111 011   */ 0,
        /*   11 111 100   */ 0,
        /*   11 111 101   */ 0,
        /*   11 111 110   */ 0,
        /*   11 111 111   */ 0
    };

    AddOpcode(RAM8(PC));

    int index = PCandInc();

    if(secondLevel[index] == 0)
    {
        return 0;
    }

    return secondLevel[index]();
}
