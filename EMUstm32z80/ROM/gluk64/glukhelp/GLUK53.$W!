Ну, для начала пара слов по поводу: Задумал Исаев Андрей себеновый "Глюк" заиметь. И, поскольку глюкописец рядом (я) -обратился ко мне. Довольно скоро достигли консенсуса и забутылку пива, выпитую мною авансом, я подрядился ему поправитьглюк 5.2 до 5.3. Все ниже поправленное отмечено ">". Я не будутут описывать что и как сделать, дабы эта прошивка заработала,об этом было много сказано в предыдущих сериях нашего сериала"хелп" 4.1,4.2, 5.0, 5.1. Стоит лишь отметить, что кромеобычного расположения в верхней четверти м/с 27512 возможнатакже замена 128-го басица на мою прошивку. Правда, в этомслучае функция перехода в 128-ой басиц будет работать весьмаинтересно. Теперь о предмете монолога: о работе прошивки.Управление осуществляется с помощью системы меню, вложенность неболее трех. Выбор функции в меню осуществляется с помощьюстрелки. Стрелка появится только в том случае, если прогаобнаружит кемпстон мышь. Иначе ее нет и управлять придетсятолько с клавиатуры. Мышь имеет более высокий приоритет, т.еесли вы мышу навели на какую-то опцию, то как бы вы не били поклавиатуре - выбранная опция не сменится. При управлении склавиатуры:  вверх - "Q", CURSOR UP  вниз - "A", CURSOR DOWN  в конец  меню - CURSOR RIGHT  в начало меню - CURSOR LEFT  огонь - ентер, пробел.Нажатие "BREAK", "EDIT" вернет в предыдущее окно, если оно неглавное. В этом случае ничего не произойдет. Вообще эти кнопкипроизводят отказ от выбранной функции. > Для большей наглядности в 5.3 курсор помигивает. Не, вы недумайте, что вы ему понравились - просто он всем так подмигиваетВ версии 5.2 сделан автоконфигурация кнопок мыши: первая нажатаякнопка становится огнем, другая - откат, то же, что и "EDIT","BREAK" - даже при дисковых операциях - удержание ее приведет ктем же последствиям, что и "BREAK". Средняя кнопка неконфигурируется и при ее нажатии программа переходит в режимсохранения ресурса монитора - плывущие звезды. То же самоепроизойдет автоматически по прошествии 37 секунд, если не нажи-мать ничего на клаве и мыши. Такой же эффект дает нажатие "Е".Поддержаны часы по моей схеме. Вся техническая документация почасам необходимый софт доступны на ZX-Server'е. > Вот! Ключевой момент! Поддержаны часы по любой схеме!Фроловский изврат лучше не применять! Так вот: по начальнымадресам в ПЗУ расположена некая табличка:┌───────┬───────┬───────────────────────────┐│ адрес │ длина │ назначение                │├───────┼───────┼───────────────────────────┤│ #0002 │ 2байта│ регистр адреса #DFF7      ││ #0004 │ 2байта│ регистр данных (RD) #BFF7 ││ #0006 │ 1байт │ маска выключения #00      ││ #0007 │ 1байт │ маска включения #80       ││ #0008 │ 2байта│ регистр данных (WR) #BFF7 ││ #000A │ 2байта│ регистр управления #EFF7  │└───────┴───────┴───────────────────────────┘По поводу регистра данных: В схеме Глюка и аналогичных адресрегистра на запись и чтение один и тот же. Но есть такаямашинка, как Спринтер - там они разные. Такая вот долговременнаяперспектива. Поправив эту табличку под свои часы, вы всегдасможете их увидать в Глюке. Более того, при старте Глюкнастраивается на систему исчисления, и теперь борьба форматовBCD/BINARY закончилась универсальным драйвером :).По последним данным, некто написал модуль для какого-то эмуля,который мои часы эмулирует. Ред.: Вова Хекс. Больше ничего не знаю. Данный аддон пылится наZX_SERVER'e.При старте программы происходит определение наличия мыши ичасов. Однако, в силу ряда причин может потребоваться изменениесостояния определителя - например, если определитель сработалневерно, или в часах произошло разрушение времени - тогда можнокнопками "1" и "2" включать и выключать мышь и часысоответственно, игнорируя мнение определителей. Внизу экрана(2-я строка) во время работы программы можно видеть сообщение"GLUK RESET SERVICE V5.2i". Однако, если записать в ячейку #12часов символ "G", то внизу (вместо этой строки) можно увидетьсообщение, которое храниться в часах с адреса #13. Маркер конца- #FF. НО! независимо от USER MESSAGE 10 августа любого годапрошивка в нижней строке поздравляет меня (автора) с днемрождения :) > Исправлен глюк с поздравлялкой, и версия изменилась на 5.3к.Кто догадается почему 'к' - получит конфетку. :)Теперь пройдемся по главному меню:1 GLUK BOOTИз названия видно, что это бут, который написал я - Мр.Глюк.Управление осуществляется под общим интерфейсом, т.е.: а) дисковод сканируется на вынимание диска; б) выжидается 37 секунд, или принудилка мышой, или "Е". Приэтом гаснет экран, но "дисковод продолжает сканиться; в) возможен возврат назад в прошивку откатными клавишами; г) по многочисленным просьбам заменил его цвета; д) запуск осуществляется аналогично перфектовскому; > Исправлен глюк при смене дисков и отсутствии файлов на нем.Если есть кэш и в нем по адресу #00 найдена такаяпоследовательность:#0000 #18#0001 #XX - любой#0002 "GLUK",то вместо надписи "Глюк бут" получим надпись из кэша, котораяхранится за последним из описанных байтов, а при выборе опциипрога врубит кэш и попытается туда идти. Если ничего не гадить,то можно из кэша вернутся по RET назад в Глюк в родную стихию:).2 COMMANDERЛегендарный PERFECT COMMANDER. Все та же версия 1.52 спофиксенными багами и пр. Без изменений с времен 5.0.3 COMM 128Он же,только независимо от имеющейся памяти определит только128. Нужно всяким рамдискам :)4 EXIT TO:  Подменю выходов: 4.1 TR-DOS+ 4.2 TR-DOS-Выходы в тр-дос, минуя определитель резидента в 5.11 и выше;соответственно, с открытым и закрытым портом расширения. 4.3 MENU 128Переход в 128-ой басиц. Если вместо басица имеем нечто наподобиекэша, с теми же словами, что и в буте - эта опция заменитсясодержимым кэша. 4.4 BASIC 48В любимый, магнитофонный :) 4.5 NOWHERE Любимая функция - ничего не делает - :) вешает. > В версии 5.3 заменена на выход в кэш. Если кэш не найден -получим возврат в Глюк с ошибкой. Кстати, об возврате. Всефункции вызова кэша работают черезRST 0JP ERRORТаким образом, прога в кэше может проверить себя на целостность(например, подсчетом crc-32, и в случае неудачного результатавернутся в Глюк. Естественно, что память при проверке лучше незанимать - а то.. а то... плохо вам будет 4.6 TO  PROGеще подменю:  4.6.1 TO XAS BANK #51, JP #C000  4.6.2 TO STS BANK #57, JP #DB00 > Добавлен выход в sts в #17-ой банке. Пиво отрабатываю :)  4.6.3 TO ASSEMBLER BANK #14, JP #C000  4.6.4 X-COPY в тырдос, там если нету его, то кранты :). этоткопировщик в версии тырдоса от 5.11 и выше. > Крантов не будет. наличие проверяется. Возврат в Глюк вслучае отсутствия.  4.6.5 FROM ROM DISCУбрано. Вместо нее:1) очистка кэша с возвратом в главное меню;2) форматируется рамдиск (если есть) с возвратом туда же;Рамдиск - тот, что поддержан Исаевским тырдосом. Форматированиеосуществляется методом создания в памяти каталога и системногосектора рамдиска. Оные находятся в странице #50. В печальномслучае, если памяти всего 128 - то подпортится копия 5-гоэкрана, сохраненная в памяти - так что не удивляйтесь - этосистемная функция.5 MODE: ALLОткрывается меню, где можно выбрать режим запуска бутов. 48,128, или вся доступная. Защелка 128/вся висит на бите D2 порта#EFF7. Состояние защелки запоминается в часах.6 ABOUT MEОкошко с моими координатами и всякой дребеденью.7 SCREEN SAVERУникальная функция, не видел больше нигде. Позволяет вынутькартинку, которая была на экране в момент сброса, и скидыватьна диск. Вынуть можно как с 5-го экрана, так и с 7-го. Файлзапишется на диск с именем "@-SCREEN". Проверка на наличиеодноименного не производится, если уже такой есть - будет два.Кстати сказать: после сброса картинка с 5-го экрана уменьшаетсяв 2 раза и помещается в левый верхний угол экрана. Атрибутыочищаются. После того, как украли :) мою идею черессеточногопоказа :) сделал по-другому. > По требованию заказчика опять вернул черессеточность.8 DRIVE: A. Выбор дисковода для работы. Запоминается в часах.Выбор из меню.9 TRACK KEEPERМеню, где можно посмотреть 0-ой, 161-ый, записать туда иобратно. В сохраненный каталог кладется маркер. Если даже 161-ыйтрек физически существует - запарывания каталога информацией снего не произойдет. Записываемые дорожки предварительноформатируются.Ну вот - вкратце всё по функциям. Следует сказать, что дисковыеошибки повлекут за собой открытие окошка "RETRY/ABORT/IGNORE",там же после слова "RETRY" можно увидеть трек/сектор/сторону, накоторой произошел инцидент. Игнорить при записи настоятельно нерекомендую. Вся работа прошивки осуществляется стандартнымифункциями тырдоса, доступными через #3D13. Единственноеисключение - форматирование дорожки при сохранении трека. Такжепутем прямого доступа к контроллеру мгновенно останавливаетсядисковод. Однако, на эмулях все прекрасно пашет.При удержании пробела во время сброса произойдет мгновенныйзапуск тырдоса - для входа в резидент.Удержание "1" в момент сброса приведет к запуску STS'а:BANK #57, JP #DB00. Порчи ОЗУ не происходит - однако состояниепрерываний и некоторые регистры все же теряются.Настоятельно рекомендую использовать эту прошивку совместно стырдосом 5.11 и выше. Глубоко признателен за труд по прочтению,отзывы буду рад выслушать по адресу: 2:5026/5.46 Renat Mamedov(AKA MR GLUK) Last Edited: 16.02.99P.S. В базовом варианте (тот, что в пакете) - настройка на часыпо схеме Глюка. Если надо сменить - см.выше.         ______________________________________________Данный текст является частью описания/прошивки Gluk 5.1, иследовательно, написан он Глюком, все отличия TR-DOS5.13F(m)будут выделены значком '>'.8 TR DOS V5.12п.8.1 УскорениеПосле сброса проверяется наличие резидента Honey-коммандера,если его там нет, то идем дальше, к п.8.2. Если Honey обнаружен,то происходит его запуск. К слову сказать, коммандер подвергсяпеределке - переделан на #7ffd драйвер верхней памяти, теперь онкак в Пентагоне. НО! Переделана была версия 2.5, а другой у наснет. Если кто может помочь - help! > Помогать уже не надо, все найдено и переделано.Кроме Honey-a резидентом может остаться любая прога, даже если увас всего 128. Просто необходимо правильно сформироватьзагрузочную страницу. Типичный пример - мой boot, только не тот,который в Пзу, а тот, который с музыкой. Он остается в последнейстранице и занимает только ее одну, а после любого обращения кTR-DOS по адресу 0 происходит его запуск. Также мною вчерасделана прога в is-dos, которая, будучи запущена, формируетрезидент is-dos'а, что весьма удобно: работаем в is-dos,запускаем is_res.com, нажимаем сброс, грузим чего-нибудь (подтырдосом), работаем. Потом нажимаем пробел со сбросом - быстрыйперезапуск tr-dos'а - и мы в IS-DOS. Правда всё же следуетучесть при работе с ram диском, что портятся страницы#D7,#D6,#D4.8.2 ПродолжимПри запуске тырдоса удален тест памяти - память простоочищается, что ускорило запуск. Удален автотест дисковода.Дисководы принимаются все 2х80, шаг 6 мкс. Интересноенаблюдение: у советского 5313 в паспорте шаг нормируется неболее 3 мкс. Так что, обладатели нетурбированных контроллеров,не удивляйтесь, что дисководы рычат. > Также значительно ускорено чтение с диска.8.3 X-COPYТрековый копировщик. Помещен в свободную область тырдоса,кстати, все изменения тырдоса не коснулись родионовского вектора- #0900-#09ff, так что все проги идут ок. Позволяет копироватькак тырдосовские, так и профинские СР/М диски, можно установитьпоследнюю копируемую дорожку, перед записью можно дискформатировать, чтение осуществляет турболоадер, что принесоответствии выбранному формату зацикливает на чтении - затобыстро. Перенесен без изменений из версии 5.11F > в версии 5.13 вобще удален за ненадобностью.Можно войти из командной строки в тыр-досе: COPY A. COPY B -запуск стандартного тырдосовского копировщика.8.4 MAGICЗначительно расширены функции волшебной кнопищи. При ее нажатиикомп подвешивается, и ждет нажатия: 1 - запуск стандартной процедуры сохранения, не только ещесохраняется, но при загрузке восстанавливается и корректируетсярегистр R. 2 - то же самое, но стек помещается в низ экрана. Предназначенодля взлома. 3 - Переход в sts. BANK=#57.Два числа на стеке и несколько байт в области атрибутов - взависимости от положения стека. Перед входом в sts гаситсямузыкалка. PC в sts'е показывает место останова, но не всегда.Его можно точно узнать под стеком. 4 - Возврат в программу. Выполняет функцию паузы. В некоторыхпрогах стоит проверка на адрес 102 - перехода в тырдосе, и, еслиmagic нестандартный, то облом. В данной версии такие проверки ненайдут отличий: перехват осуществлен в начале засирания стека.Кстати, не знаю я таких программ, которые не работают из-подмоей ПЗУ или же из под тырдоса 5.12 - даже если и есть одна -две, то я ими пожертвовал бы ради этого кайфа. Правда, щас народвсе больше на эмуляторах8.5 FORMATTERПосле ввода FORMAT "NAME" появляется стандартный запрос наобычный или турбо формат. При выборе турбо формата диск будетформатироватся с радиальным смещением секторов - на каждойследующей дорожке сектора начинаются позже, чем на предыдущей,для компенсации задержек в программе и шага дисковода. Прикопировании в PC дает ощутимый выигрыш во времени. > Запрос немного видоизменился. Теперь, чтобы диск былотформатирован как турбо, можно жать любую клавишу, а вот длямедленного формата необходимо нажать 'S'.На диске 'D' вместо реального драйва висит рам-диск. На данныймомент имеются две версии досов: в одной рам-диск сделан для512К по порту #7FFD и имеет полезный объём 1520 секторов, а вдругой для 1024К по порту #7FFD бит защелки порта и имеет объём3568 секторов. Первая версия зовется 5.13F, a вторая - 5.13Fm.Естественно, убран глюк с позиционированием, описаный в одном изномеров ZX-FORFMAT'a. Для того чтобы узнать дату компиляцииверсии, необходимо в досе ввести команду NEW, после чего наэкране получим конструкцию типа "Rel: 16.03.99."ПРИЛОЖЕНИЕ GLUK TS.B - сие файло запускает прошивку из памяти. Тем, ктохочет посмотреть на неё, не зашивая ROM53.C - собственно файл прошивки. В начале часовой сетап. dos13f(m) - прошивки вместо TR-DOS'а. Для понимания "что естьдля чего" ещё раз прочитай статью